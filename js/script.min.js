const log=console.log;let GAME_={status:!1,end:!1,active:!1,score:0,combo:0,bestResult:window.localStorage.getItem("bestResult")?window.localStorage.getItem("bestResult"):0,newRecord:!1,designPalette:0};const colorDesign=[[30,70,50],[120,80,60],[224,68,62],[251,50,60],[339,62,48],[231,50,47]],boxSize={x:3,y:1,z:3,range:10},c_width=10,cameraPos={width:10,height:window.innerHeight/window.innerWidth*10,near:1,far:100,size:window.innerWidth>700?1:2};let world,scene,camera,renderer,fncStart,stackBoxArr=[],outBoxArr=[];function playConfetti(e,t){party.confetti(party.Rect.fromScreen(),{count:party.variation.range(e||60,t||80)})}function playBot(e,t,o=!0){setInterval(()=>{const t=stackBoxArr[stackBoxArr.length-1],n=stackBoxArr[stackBoxArr.length-2];let s=t.direction,r=t.threejs.position[s]-n.threejs.position[s],i=Math.abs(r),a="x"===s?t.width:t.depth;const c=(a-i)/a;c>=(e||.99)&&(fncStart(),o&&console.log(c))},t||20)}window.addEventListener("load",()=>{let e=document.querySelector(".result-area"),t=document.querySelector(".point-result"),o=document.querySelector(".score-tab"),n=document.querySelector(".combo-strike"),s=document.querySelector(".combo-extra-point");function r(e){scene.background=new THREE.Color(d(colorDesign[GAME_.designPalette][0]+120+stackBoxArr.length,colorDesign[GAME_.designPalette][1],colorDesign[GAME_.designPalette][2]))}function i(e){t.innerHTML=e}function a(e,t,o,n,s){const r=c(e,boxSize.y*stackBoxArr.length,t,o,n,!1);r.direction=s,r.positive=!0,stackBoxArr.push(r)}function c(e,t,o,n,s,r=!1){let i=r?4*(stackBoxArr.length-1):4*stackBoxArr.length;const a=new THREE.Color(d(colorDesign[GAME_.designPalette][0]+i,colorDesign[GAME_.designPalette][1],colorDesign[GAME_.designPalette][2])),c=new THREE.BoxGeometry(n,boxSize.y,s),l=new THREE.MeshLambertMaterial({color:a}),h=new THREE.Mesh(c,l);h.position.set(e,t,o);const p=new CANNON.Box(new CANNON.Vec3(n/2,boxSize.y/2,s/2));let A=r?5:0;const w=new CANNON.Body({mass:A,shape:p});return w.position.set(e,t,o),world.addBody(w),scene.add(h),{threejs:h,geometry:c,material:l,cannonjs:w,x:e,y:t,z:o,width:n,depth:s}}function d(e,t,o){o=o>101?100:o,o/=100;const n=t*Math.min(o,1-o)/100,s=t=>{const s=(t+e/30)%12,r=o-n*Math.max(Math.min(s-3,9-s,1),-1);return Math.round(255*r).toString(16).padStart(2,"0")};return`#${s(0)}${s(8)}${s(4)}`}(world=new CANNON.World).gravity.set(0,-9.8,0),world.broadphase=new CANNON.NaiveBroadphase,world.solver.interations=40,i(GAME_.bestResult),scene=new THREE.Scene,r(),a(0,0,boxSize.x,boxSize.z,"x");const l=new THREE.AmbientLight(16777215,.6);scene.add(l);const h=new THREE.DirectionalLight(16777215,.6);function p(){if(GAME_.end)stackBoxArr[stackBoxArr.length-1].threejs.position.copy(stackBoxArr[stackBoxArr.length-1].cannonjs.position),stackBoxArr[stackBoxArr.length-1].threejs.quaternion.copy(stackBoxArr[stackBoxArr.length-1].cannonjs.quaternion);else{const e=stackBoxArr[stackBoxArr.length-1],t=e.positive?.15:-.15;e.threejs.position[e.direction]>=boxSize.range-5&&(e.positive=!1),e.threejs.position[e.direction]<=-(boxSize.range-5)&&(e.positive=!0),e.threejs.position[e.direction]+=t,e.cannonjs.position[e.direction]+=t,camera.position.y<boxSize.y*(stackBoxArr.length-2)+4&&(camera.position.y+=t)}world.step(1/60),outBoxArr.forEach(e=>{e.threejs.position.copy(e.cannonjs.position),e.threejs.quaternion.copy(e.cannonjs.quaternion)}),renderer.render(scene,camera)}h.position.set(10,20,0),scene.add(h),(camera=new THREE.OrthographicCamera(cameraPos.width/-cameraPos.size,cameraPos.width/cameraPos.size,cameraPos.height/cameraPos.size,cameraPos.height/-cameraPos.size,cameraPos.near,cameraPos.far)).position.set(4,4,4),camera.lookAt(0,0,0),(renderer=new THREE.WebGLRenderer({antialias:!0})).setSize(window.innerWidth,window.innerHeight),renderer.render(scene,camera),document.body.appendChild(renderer.domElement),fncStart=(()=>{if(GAME_.status){let d,l;const h=stackBoxArr[stackBoxArr.length-1],p=stackBoxArr[stackBoxArr.length-2];let A=h.direction,w=h.threejs.position[A]-p.threejs.position[A],x=Math.abs(w),m="x"===A?h.width:h.depth,g=m-x;if(g>0){const e=g/m;e>=.9?([9,19,29,39,49].includes(GAME_.combo)&&(s.classList.add("active"),setTimeout(()=>{s.classList.remove("active")},1100),GAME_.score+=10),GAME_.combo+=1,n.innerHTML=`x${GAME_.combo}`,n.classList.add("open"),setTimeout(()=>{n.classList.remove("open")},700)):GAME_.combo&&(GAME_.combo=0),d="x"===A?g:h.width,l="z"===A?g:h.depth,h.width=d,h.depth=l,h.threejs.scale[A]=e,h.threejs.position[A]-=w/2,h.cannonjs.position[A]-=w/2;const t=new CANNON.Box(new CANNON.Vec3(d/2,boxSize.y/2,l/2));if(h.cannonjs.shapes=[],h.cannonjs.addShape(t),x>=.01){let e=Math.sign(w)*(g/2+x/2);const t={x:"x"===A?h.threejs.position.x+e:h.threejs.position.x,z:"z"===A?h.threejs.position.z+e:h.threejs.position.z,width:"x"===A?x:d,depth:"z"===A?x:l};!function(e,t,o,n){const s=c(e,boxSize.y*(stackBoxArr.length-1),t,o,n,!0);outBoxArr.push(s)}(t.x,t.z,t.width,t.depth)}a("x"===A?h.threejs.position.x:-(boxSize.range-1),"z"===A?h.threejs.position.z:-(boxSize.range-1),d,l,"x"===A?"z":"x"),GAME_.score++,r(),i(GAME_.score)}else{GAME_.end=!0,world.remove(h.cannonjs);const n=new CANNON.Box(new CANNON.Vec3(h.width/2,boxSize.y/2,h.depth/2));let s=5;const r=new CANNON.Body({mass:s,shape:n});r.position.set(h.threejs.position.x,h.threejs.position.y,h.threejs.position.z),world.addBody(r),h.cannonjs=r,e.classList.toggle("disable"),t.classList.toggle("active"),GAME_.status=!1,GAME_.score>GAME_.bestResult&&(playConfetti(),GAME_.bestResult=GAME_.score,window.localStorage.setItem("bestResult",GAME_.score),o.classList.add("new"),GAME_.newRecord=!0),enableDownload&&document.querySelector("#pwa-install").classList.add("display")}}else GAME_.active?(GAME_.designPalette=Math.floor(Math.random()*colorDesign.length),camera.position.set(4,4,4),camera.lookAt(0,0,0),stackBoxArr.forEach(e=>{scene.remove(e.threejs),e.geometry.dispose(),e.material.dispose(),world.removeBody(e.cannonjs)}),outBoxArr.forEach(e=>{scene.remove(e.threejs),e.geometry.dispose(),e.material.dispose(),world.removeBody(e.cannonjs)}),stackBoxArr=[],outBoxArr=[],GAME_.score=0,GAME_.combo=0,r(),a(0,0,boxSize.x,boxSize.z,"x")):(renderer.setAnimationLoop(p),GAME_.active=!0),i(GAME_.score),a(0,0,boxSize.x,boxSize.z,"z"),e.classList.toggle("disable"),t.classList.toggle("active"),document.querySelector("#pwa-install").classList.remove("display"),GAME_.newRecord&&(GAME_.newRecord=!1,o.classList.remove("new")),GAME_.status=!0,GAME_.end=!1});let A="ontouchstart"in window||navigator.msMaxTouchPoints?"touchstart":"mousedown";window.addEventListener(A,e=>{e.target.className.split(" ").some(e=>/pwa-.*/.test(e))||fncStart()});let w=!0;window.addEventListener("keydown",function(e){32!==e.keyCode&&40!==e.keyCode&&" "!==e.key||(e.preventDefault(),w&&(w=!1,fncStart()))}),window.addEventListener("keyup",function(e){32!==e.keyCode&&40!==e.keyCode&&" "!==e.key||(w=!0)})});