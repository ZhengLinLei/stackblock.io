function playConfetti(){party.confetti(party.Rect.fromScreen(),{count:party.variation.range(60,80)})}let GAME_={status:!1,end:!1,active:!1,score:0,bestResult:window.localStorage.getItem("bestResult")?window.localStorage.getItem("bestResult"):0,newRecord:!1,designPalette:0};const colorDesign=[[Math.floor(360*Math.random()),50,70],[200,80,60]],boxSize={x:3,y:1,z:3,range:10},c_width=10,cameraPos={width:c_width,height:c_width*(window.innerHeight/window.innerWidth),near:1,far:100,size:window.innerWidth>700?1:2};let world,scene,camera,renderer,stackBoxArr=[],outBoxArr=[];window.addEventListener("load",()=>{function e(){scene.background=new THREE.Color(i(colorDesign[GAME_.designPalette][0]+120+4*stackBoxArr.length,colorDesign[GAME_.designPalette][1],colorDesign[GAME_.designPalette][2]))}function t(e){l.innerHTML=e}function o(e,t,o,n){const r=boxSize.y*(stackBoxArr.length-1),i=s(e,r,t,o,n,!0);outBoxArr.push(i)}function n(){world.step(1/60),outBoxArr.forEach(e=>{e.threejs.position.copy(e.cannonjs.position),e.threejs.quaternion.copy(e.cannonjs.quaternion)})}function r(e,t,o,n,r){const i=boxSize.y*stackBoxArr.length,a=s(e,i,t,o,n,!1);a.direction=r,a.positive=!0,stackBoxArr.push(a)}function s(e,t,o,n,r,s=!1){let a=s?4*(stackBoxArr.length-1):4*stackBoxArr.length;const c=new THREE.Color(i(colorDesign[GAME_.designPalette][0]+a,colorDesign[GAME_.designPalette][1],colorDesign[GAME_.designPalette][2])),d=new THREE.BoxGeometry(n,boxSize.y,r),l=new THREE.MeshLambertMaterial({color:c}),h=new THREE.Mesh(d,l);h.position.set(e,t,o);const x=new CANNON.Box(new CANNON.Vec3(n/2,boxSize.y/2,r/2));let w=s?5:0;const A=new CANNON.Body({mass:w,shape:x});return A.position.set(e,t,o),world.addBody(A),scene.add(h),{threejs:h,geometry:d,material:l,cannonjs:A,x:e,y:t,z:o,width:n,depth:r}}function i(e,t,o){o=o>101?100:o,o/=100;const n=t*Math.min(o,1-o)/100,r=t=>{const r=(t+e/30)%12,s=o-n*Math.max(Math.min(r-3,9-r,1),-1);return Math.round(255*s).toString(16).padStart(2,"0")};return`#${r(0)}${r(8)}${r(4)}`}function a(){camera.position.set(4,4,4),camera.lookAt(0,0,0),stackBoxArr.forEach(e=>{scene.remove(e.threejs),e.geometry.dispose(),e.material.dispose(),world.removeBody(e.cannonjs)}),outBoxArr.forEach(e=>{scene.remove(e.threejs),e.geometry.dispose(),e.material.dispose(),world.removeBody(e.cannonjs)}),stackBoxArr=[],outBoxArr=[],GAME_.score=0,r(0,0,boxSize.x,boxSize.z,"x")}function c(){if(GAME_.end)stackBoxArr[stackBoxArr.length-1].threejs.position.copy(stackBoxArr[stackBoxArr.length-1].cannonjs.position),stackBoxArr[stackBoxArr.length-1].threejs.quaternion.copy(stackBoxArr[stackBoxArr.length-1].cannonjs.quaternion);else{const e=stackBoxArr[stackBoxArr.length-1],t=e.positive?.15:-.15;e.threejs.position[e.direction]>=boxSize.range-5&&(e.positive=!1),e.threejs.position[e.direction]<=-(boxSize.range-5)&&(e.positive=!0),e.threejs.position[e.direction]+=t,e.cannonjs.position[e.direction]+=t,camera.position.y<boxSize.y*(stackBoxArr.length-2)+4&&(camera.position.y+=t)}n(),renderer.render(scene,camera)}let d=document.querySelector(".result-area"),l=document.querySelector(".point-result"),h=document.querySelector(".score-tab");world=new CANNON.World,world.gravity.set(0,-9.8,0),world.broadphase=new CANNON.NaiveBroadphase,world.solver.interations=40,t(GAME_.bestResult),scene=new THREE.Scene,e(),r(0,0,boxSize.x,boxSize.z,"x");const x=new THREE.AmbientLight(16777215,.6);scene.add(x);const w=new THREE.DirectionalLight(16777215,.6);w.position.set(10,20,0),scene.add(w),camera=new THREE.OrthographicCamera(cameraPos.width/-cameraPos.size,cameraPos.width/cameraPos.size,cameraPos.height/cameraPos.size,cameraPos.height/-cameraPos.size,cameraPos.near,cameraPos.far),camera.position.set(4,4,4),camera.lookAt(0,0,0),renderer=new THREE.WebGLRenderer({antialias:!0}),renderer.setSize(window.innerWidth,window.innerHeight),renderer.render(scene,camera),document.body.appendChild(renderer.domElement);const A=()=>{if(GAME_.status){let e,n;const s=stackBoxArr[stackBoxArr.length-1],i=stackBoxArr[stackBoxArr.length-2];let a=s.direction,c=s.threejs.position[a]-i.threejs.position[a],x=Math.abs(c),w="x"===a?s.width:s.depth,A=w-x;if(A>0){e="x"===a?A:s.width,n="z"===a?A:s.depth,s.width=e,s.depth=n,s.threejs.scale[a]=A/w,s.threejs.position[a]-=c/2,s.cannonjs.position[a]-=c/2;const i=new CANNON.Box(new CANNON.Vec3(e/2,boxSize.y/2,n/2));s.cannonjs.shapes=[],s.cannonjs.addShape(i);let d=Math.sign(c)*(A/2+x/2);const l={x:"x"===a?s.threejs.position.x+d:s.threejs.position.x,z:"z"===a?s.threejs.position.z+d:s.threejs.position.z,width:"x"===a?x:e,depth:"z"===a?x:n};o(l.x,l.z,l.width,l.depth);let h="x"===a?s.threejs.position.x:-(boxSize.range-1),p="z"===a?s.threejs.position.z:-(boxSize.range-1),g="x"===a?"z":"x";r(h,p,e,n,g),GAME_.score++,t(GAME_.score)}else{GAME_.end=!0,world.remove(s.cannonjs);const e=new CANNON.Box(new CANNON.Vec3(s.width/2,boxSize.y/2,s.depth/2));let t=5;const o=new CANNON.Body({mass:t,shape:e});o.position.set(s.threejs.position.x,s.threejs.position.y,s.threejs.position.z),world.addBody(o),s.cannonjs=o,d.classList.toggle("disable"),l.classList.toggle("active"),GAME_.status=!1,GAME_.score>GAME_.bestResult&&(playConfetti(),GAME_.bestResult=GAME_.score,window.localStorage.setItem("bestResult",GAME_.score),h.classList.add("new"),GAME_.newRecord=!0)}}else GAME_.active?a():(renderer.setAnimationLoop(c),GAME_.active=!0),t(GAME_.score),r(0,0,boxSize.x,boxSize.z,"z"),d.classList.toggle("disable"),l.classList.toggle("active"),GAME_.newRecord&&(GAME_.newRecord=!1,h.classList.remove("new")),GAME_.status=!0,GAME_.end=!1};let p="ontouchstart"in window||navigator.msMaxTouchPoints,g=p?"touchstart":"click";window.addEventListener(g,A)});