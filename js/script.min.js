let MEMORY_={localStorage:{bestResult:"bestResult",achievement:"st-ach",installNo:"installDismissed"}},GAME_={platform:navigator.userAgent.match(/(iPad|iPhone|iPod)/g)?"ios":navigator.userAgent.match(/(Android)/g)?"android":navigator.userAgent.match(/(Windows)/g)?"windows":navigator.userAgent.match(/(Mac)/g)?"mac":navigator.userAgent.match(/(Linux)/g)?"linux":"unknown",status:!1,fpsCtrl:{forceLag:!1,fps:60,mFps:0,fpsInterval:0,now:0,then:0,delta:0,lagWarning:{enable:!0,lastWarning:0,frames:0,framesMax:180}},end:!1,active:!1,score:0,combo:0,gamesPlayed:0,bestResult:window.localStorage.getItem(MEMORY_.localStorage.bestResult)??0,newRecord:!1,designPalette:0,screenshot:{service:!0,enable:!1,frames:0,framesMax:5,callback:null,blob:null},botMode:!1,confetti:{range:[30,50]},zoomOut:{service:!0,enable:!1,frames:0,framesMax:20,finished:!1},colorDesign:[[30,70,50],[120,80,60],[224,68,62],[251,50,60],[339,62,48],[231,50,47],[165,30,68]],boxSize:{x:3,y:1,z:3,range:10},c_width:10,cameraPos:{width:10,height:window.innerHeight/window.innerWidth*10,near:1,far:100,size:700<window.innerWidth?1:2},world:void 0,scene:void 0,camera:void 0,renderer:void 0,fncStart:void 0,stackBoxArr:[],outBoxArr:[],achievement:JSON.parse(window.localStorage.getItem(MEMORY_.localStorage.achievement))??{default:{message:"Default"}}};function playConfetti(e,t){party.confetti(party.Rect.fromScreen(),{count:party.variation.range(e||60,t||80)})}function playBot(i,e,c=!0){GAME_.unlockAchieve("cheater","Faker, cheater... ðŸ¤¬"),GAME_.botMode=!0;setInterval(()=>{try{var e=GAME_.stackBoxArr[GAME_.stackBoxArr.length-1],t=GAME_.stackBoxArr[GAME_.stackBoxArr.length-2],o=e.direction,a=e.threejs.position[o]-t.threejs.position[o],r=Math.abs(a),n="x"===o?e.width:e.depth,s=(n-r)/n;(i||.95)<=s&&(fncStart(),c)&&console.log(s)}catch(e){fncStart()}},e||20)}window.addEventListener("load",()=>{"ios"===GAME_.platform&&navigator.userAgent.match(/(Safari)/g)&&(document.querySelector(".pwa-install-title").innerText="Apple StackBlock.io",document.querySelector(".pwa-install-description").innerHTML='Download the APP in <img src="https://help.apple.com/assets/64F2669B7BEF8AE318002477/64F266A17BEF8AE3180024A8/en_US/d26fe35d3438fe81179a80c2b6c9b0c9.png" width="10" originalimagename="GlobalArt/IL_ShareBlue.png">',document.querySelector(".pwa-install-button").innerHTML=`
        <a id="pwa-dismiss-btn" class="pwa-install-btn">Not now</a>
        <a id="pwa-install-btn" class="pwa-install-btn-apple" href="https://support.apple.com/en-gb/guide/iphone/iph42ab2f3a7/ios#iph4f9a47bbc">See more</a>
        `);let c=document.querySelector(".result-area"),l=document.querySelector(".point-result"),A=document.querySelector(".score-tab"),M=document.querySelector(".combo-strike"),E=document.querySelector(".combo-extra-point");var e=document.querySelector("#click-event");let d=document.querySelector("#record-share");function _(e=!1){let t=h(GAME_.colorDesign[GAME_.designPalette][0]+120+GAME_.stackBoxArr.length,GAME_.colorDesign[GAME_.designPalette][1],GAME_.colorDesign[GAME_.designPalette][2]);GAME_.scene.background=new THREE.Color(t),e&&(t=h(GAME_.colorDesign[GAME_.designPalette][0]+120+GAME_.stackBoxArr.length,GAME_.colorDesign[GAME_.designPalette][1],10)),document.querySelector('meta[name="theme-color"]').setAttribute("content",t),document.body.style.backgroundColor=t,"windows"===GAME_.platform&&document.querySelector('meta[name="msapplication-TileColor"]').setAttribute("content",t)}function G(e){l.innerHTML=e}function m(e,t,o,a,r){e=p(e,GAME_.boxSize.y*GAME_.stackBoxArr.length,t,o,a,!1);e.direction=r,e.positive=!0,GAME_.stackBoxArr.push(e)}function p(e,t,o,a,r,n=!1){var s=n?4*(GAME_.stackBoxArr.length-1):4*GAME_.stackBoxArr.length,s=new THREE.Color(h(GAME_.colorDesign[GAME_.designPalette][0]+s,GAME_.colorDesign[GAME_.designPalette][1],GAME_.colorDesign[GAME_.designPalette][2])),i=new THREE.BoxGeometry(a,GAME_.boxSize.y,r),s=new THREE.MeshLambertMaterial({color:s}),c=new THREE.Mesh(i,s),l=(c.position.set(e,t,o),new CANNON.Box(new CANNON.Vec3(a/2,GAME_.boxSize.y/2,r/2))),n=new CANNON.Body({mass:n?5:0,shape:l});return n.position.set(e,t,o),GAME_.world.addBody(n),GAME_.scene.add(c),{threejs:c,geometry:i,material:s,cannonjs:n,x:e,y:t,z:o,width:a,depth:r}}function h(t,e,o){o=101<o?100:o,o/=100;const a=e*Math.min(o,1-o)/100;e=e=>{e=(e+t/30)%12,e=o-a*Math.max(Math.min(e-3,9-e,1),-1);return Math.round(255*e).toString(16).padStart(2,"0")};return"#"+e(0)+e(8)+e(4)}function g(){GAME_.camera.right=GAME_.cameraPos.width/GAME_.cameraPos.size,GAME_.camera.left=GAME_.cameraPos.width/-GAME_.cameraPos.size,GAME_.camera.top=GAME_.cameraPos.height/GAME_.cameraPos.size,GAME_.camera.bottom=GAME_.cameraPos.height/-GAME_.cameraPos.size,GAME_.camera.updateProjectionMatrix()}function u(){return"now"in window?now():("now"in performance&&"performance"in window?performance:Date).now()}function t(){GAME_.cameraPos.height=GAME_.c_width*(window.innerHeight/window.innerWidth),GAME_.cameraPos.size=700<window.innerWidth?1:2,g(),GAME_.renderer.setSize(window.innerWidth,window.innerHeight),GAME_.renderer.render(GAME_.scene,GAME_.camera)}function o(e){document.querySelector("#noti-popup").classList.remove("display"),document.querySelector("#noti-popup-text").innerText=e,document.querySelector("#noti-popup").classList.add("display"),setTimeout(()=>document.querySelector("#noti-popup").classList.remove("display"),5200)}GAME_.unlockAchieve=(e,t)=>{e in GAME_.achievement||(GAME_.achievement[e]={message:t},console.log(GAME_.achievement[e]),document.querySelector("#achie-text .message").innerHTML=t,document.querySelector("#achie-popup").classList.remove("display"),document.querySelector("#achie-popup").classList.add("display"),setTimeout(()=>document.querySelector("#noti-popup").classList.remove("display"),5200),localStorage.setItem(MEMORY_.localStorage.achievement,JSON.stringify(GAME_.achievement)))};let f=GAME_.unlockAchieve;GAME_.world=new CANNON.World,GAME_.world.gravity.set(0,-9.8,0),GAME_.world.broadphase=new CANNON.NaiveBroadphase,GAME_.world.solver.interations=40,G(GAME_.bestResult),GAME_.scene=new THREE.Scene,_(hslDark=!0),m(0,0,GAME_.boxSize.x,GAME_.boxSize.z,"x");var a=new THREE.AmbientLight(16777215,.6),a=(GAME_.scene.add(a),new THREE.DirectionalLight(16777215,.6));function r(){var e,t;GAME_.end?(GAME_.stackBoxArr[GAME_.stackBoxArr.length-1].threejs.position.copy(GAME_.stackBoxArr[GAME_.stackBoxArr.length-1].cannonjs.position),GAME_.stackBoxArr[GAME_.stackBoxArr.length-1].threejs.quaternion.copy(GAME_.stackBoxArr[GAME_.stackBoxArr.length-1].cannonjs.quaternion),GAME_.zoomOut.enable&&(GAME_.cameraPos.size-=.02,g(),GAME_.zoomOut.frames++,GAME_.zoomOut.frames>=GAME_.zoomOut.framesMax)&&(GAME_.zoomOut.enable=!1,GAME_.zoomOut.frames=0,GAME_.zoomOut.finished=!0)):(t=(e=GAME_.stackBoxArr[GAME_.stackBoxArr.length-1]).positive?.15:-.15,e.threejs.position[e.direction]>=GAME_.boxSize.range-5&&(e.positive=!1),e.threejs.position[e.direction]<=-(GAME_.boxSize.range-5)&&(e.positive=!0),e.threejs.position[e.direction]+=t,e.cannonjs.position[e.direction]+=t,GAME_.camera.position.y<GAME_.boxSize.y*(GAME_.stackBoxArr.length-2)+4&&(GAME_.camera.position.y+=t)),GAME_.world.step(1/60),GAME_.outBoxArr.forEach(e=>{e.threejs.position.copy(e.cannonjs.position),e.threejs.quaternion.copy(e.cannonjs.quaternion)}),GAME_.renderer.render(GAME_.scene,GAME_.camera),GAME_.screenshot.enable&&(GAME_.screenshot.frames>=GAME_.screenshot.framesMax?GAME_.zoomOut.finished&&(DrawCanvasCopy(GAME_.renderer.domElement,e=>{e.fillStyle="rgba(0, 0, 0, 0.2)",e.fillRect(0,0,e.canvas.width,e.canvas.height),e.fillStyle="#ffffff",e.font="32px monospace";var t="NEW RECORD",o=e.measureText(t).width;e.fillText(t,e.canvas.width/2-o/2,e.canvas.height/2-100),e.font="bold 64px monospace",t=GAME_.score,o=e.measureText(t).width,e.fillText(t,e.canvas.width/2-o/2,e.canvas.height/2+50),GAME_.botMode&&(e.save(),e.translate(e.canvas.width/2,e.canvas.height/2+50),e.rotate(-Math.PI/8),e.fillStyle="rgba(255, 0, 0, 0.6)",e.font="bold 64px monospace",o=e.measureText(t="FAKE").width,e.fillText(t,-o/2,0),e.strokeStyle="rgba(255, 0, 0, 0.5)",e.lineWidth=5,e.strokeRect(-(o/2+10),-51.152,o+20,56.152),e.restore())},e=>{var t=document.createElement("img");const o=URL.createObjectURL(e);t.onload=()=>{URL.revokeObjectURL(o)},t.src=o,GAME_.screenshot.blob=e,GAME_.screenshot.callback(t)}),GAME_.screenshot.enable=!1,GAME_.screenshot.frames=0):GAME_.screenshot.frames++)}function w(){requestAnimationFrame(w),GAME_.fpsCtrl.now=u(),GAME_.fpsCtrl.elapsed=GAME_.fpsCtrl.now-GAME_.fpsCtrl.then,GAME_.fpsCtrl.elapsed>GAME_.fpsCtrl.fpsInterval&&(GAME_.fpsCtrl.mFps=Math.round(1e3/GAME_.fpsCtrl.elapsed)-(GAME_.fpsCtrl.forceLag?30:0),GAME_.fpsCtrl.mFps<GAME_.fpsCtrl.fps/2?GAME_.fpsCtrl.lagWarning.frames>=GAME_.fpsCtrl.lagWarning.framesMax?(GAME_.fpsCtrl.lagWarning.lastWarning+3e4<GAME_.fpsCtrl.now&&(GAME_.fpsCtrl.lagWarning.lastWarning=GAME_.fpsCtrl.now,GAME_.fpsCtrl.lagWarning.enable=!0),GAME_.fpsCtrl.lagWarning.enable&&(GAME_.fpsCtrl.lagWarning.enable=!1,o("May be laggy. Try to close other apps"),GAME_.fpsCtrl.lagWarning.frames=0)):GAME_.fpsCtrl.lagWarning.frames++:GAME_.fpsCtrl.lagWarning.frames=0,GAME_.fpsCtrl.then=GAME_.fpsCtrl.now-GAME_.fpsCtrl.elapsed%GAME_.fpsCtrl.fpsInterval,r())}a.position.set(10,20,0),GAME_.scene.add(a),GAME_.camera=new THREE.OrthographicCamera(GAME_.cameraPos.width/-GAME_.cameraPos.size,GAME_.cameraPos.width/GAME_.cameraPos.size,GAME_.cameraPos.height/GAME_.cameraPos.size,GAME_.cameraPos.height/-GAME_.cameraPos.size,GAME_.cameraPos.near,GAME_.cameraPos.far),GAME_.camera.position.set(4,4,4),GAME_.camera.lookAt(0,0,0),GAME_.renderer=new THREE.WebGLRenderer({antialias:!0}),GAME_.renderer.setSize(window.innerWidth,window.innerHeight),GAME_.renderer.render(GAME_.scene,GAME_.camera),GAME_.renderer.domElement.id="Stackblock",document.body.appendChild(GAME_.renderer.domElement),"deviceMemory"in navigator&&(navigator.deviceMemory<=32?GAME_.confetti.range=[10*Math.log2(navigator.deviceMemory),10*Math.log2(navigator.deviceMemory)+20].map(Math.round):GAME_.confetti.range=[50,70]),fncStart=()=>{if(GAME_.status){var e,t,o=GAME_.stackBoxArr[GAME_.stackBoxArr.length-1],a=GAME_.stackBoxArr[GAME_.stackBoxArr.length-2],r=o.direction,a=o.threejs.position[r]-a.threejs.position[r],n=Math.abs(a),s="x"===r?o.width:o.depth,i=s-n;if(0<i){s=i/s;if(n<.2){switch([9,19,29,39,49].includes(GAME_.combo)&&(E.classList.add("active"),setTimeout(()=>{E.classList.remove("active")},1100),GAME_.score+=10),GAME_.combo+=1,GAME_.combo){case 10:f("combo","Combo Master");break;case 20:f("combo2","Combo Super Master");break;case 30:f("combo3","Combo Super Master God")}M.innerHTML="x"+GAME_.combo,M.classList.add("open"),setTimeout(()=>{M.classList.remove("open")},700)}else GAME_.combo&&(GAME_.combo=0);e="x"===r?i:o.width,t="z"===r?i:o.depth,o.width=e,o.depth=t,o.threejs.scale[r]=s,o.threejs.position[r]-=a/2,o.cannonjs.position[r]-=a/2;var s=new CANNON.Box(new CANNON.Vec3(e/2,GAME_.boxSize.y/2,t/2)),i=(o.cannonjs.shapes=[],o.cannonjs.addShape(s),.01<=n&&(s=Math.sign(a)*(i/2+n/2),a={x:"x"===r?o.threejs.position.x+s:o.threejs.position.x,z:"z"===r?o.threejs.position.z+s:o.threejs.position.z,width:"x"===r?n:e,depth:"z"===r?n:t},i=a.z,s=a.width,n=a.depth,a=p(a=a.x,GAME_.boxSize.y*(GAME_.stackBoxArr.length-1),i,s,n,!0),GAME_.outBoxArr.push(a)),"x"===r?o.threejs.position.x:-(GAME_.boxSize.range-1));m(i,"z"===r?o.threejs.position.z:-(GAME_.boxSize.range-1),e,t,"x"===r?"z":"x"),GAME_.score++,G(GAME_.score)}else{localStorage.getItem(MEMORY_.localStorage.bestResult)||f("noob","First time playing"),GAME_.end=!0,GAME_.world.remove(o.cannonjs);s=new CANNON.Box(new CANNON.Vec3(o.width/2,GAME_.boxSize.y/2,o.depth/2)),n=new CANNON.Body({mass:5,shape:s}),a=(n.position.set(o.threejs.position.x,o.threejs.position.y,o.threejs.position.z),GAME_.world.addBody(n),o.cannonjs=n,c.classList.toggle("disable"),l.classList.toggle("active"),GAME_.status=!1,GAME_.score>GAME_.bestResult&&(playConfetti(GAME_.confetti.range[0],GAME_.confetti.range[1]),GAME_.botMode||(GAME_.bestResult=GAME_.score,window.localStorage.setItem(MEMORY_.localStorage.bestResult,GAME_.score)),A.classList.add("new"),GAME_.newRecord=!0,GAME_.screenshot.service)&&(GAME_.screenshot.callback=e=>{d.replaceChild(e,d.querySelector("img")),d.classList.add("display")},GAME_.screenshot.enable=!0),GAME_.zoomOut.service&&(GAME_.zoomOut.enable=!0),localStorage.getItem(MEMORY_.localStorage.installNo)??!1);!enableDownload||"false"!=a&&a||(document.querySelector("#pwa-install").classList.add("display"),0<GAME_.gamesPlayed&&document.querySelector("#pwa-dismiss-btn").classList.add("display")),GAME_.gamesPlayed++}}else GAME_.active?(GAME_.designPalette=Math.floor(Math.random()*GAME_.colorDesign.length),GAME_.cameraPos.size=700<window.innerWidth?1:2,g(),GAME_.camera.position.set(4,4,4),GAME_.camera.lookAt(0,0,0),GAME_.zoomOut.finished=!1,GAME_.stackBoxArr.forEach(e=>{GAME_.scene.remove(e.threejs),e.geometry.dispose(),e.material.dispose(),GAME_.world.removeBody(e.cannonjs)}),GAME_.outBoxArr.forEach(e=>{GAME_.scene.remove(e.threejs),e.geometry.dispose(),e.material.dispose(),GAME_.world.removeBody(e.cannonjs)}),GAME_.stackBoxArr=[],GAME_.outBoxArr=[],GAME_.score=0,GAME_.combo=0,_(),m(0,0,GAME_.boxSize.x,GAME_.boxSize.z,"x"),document.querySelector("#pwa-install").classList.remove("display"),d.classList.remove("display"),document.querySelector("#noti-popup").classList.remove("display")):(GAME_.fpsCtrl.fps=GAME_.fpsCtrl.forceLag?GAME_.fpsCtrl.fps/2:GAME_.fpsCtrl.fps,GAME_.fpsCtrl.fpsInterval=1e3/GAME_.fpsCtrl.fps,GAME_.fpsCtrl.then=u(),w(),GAME_.active=!0,A.querySelector(".score").innerHTML="SCORE"),G(GAME_.score),m(0,0,GAME_.boxSize.x,GAME_.boxSize.z,"z"),c.classList.toggle("disable"),l.classList.toggle("active"),GAME_.newRecord&&(GAME_.newRecord=!1,A.classList.remove("new")),GAME_.status=!0,GAME_.end=!1;_(hslDark=GAME_.end)};a="ontouchstart"in window||navigator.msMaxTouchPoints?"touchstart":"mousedown";e.addEventListener(a,fncStart);let n=!0;window.addEventListener("keydown",function(e){32!==e.keyCode&&40!==e.keyCode&&" "!==e.key||(e.preventDefault(),n&&(n=!1,fncStart()))}),window.addEventListener("keyup",function(e){32!==e.keyCode&&40!==e.keyCode&&" "!==e.key||(n=!0)}),window.addEventListener("resize",e=>t()),window.addEventListener("orientationchange",e=>{t()}),d.addEventListener(a,async()=>{await Blob2Share(GAME_.screenshot.blob,"ios"==GAME_.platform)||o("Unable to share. Take screenshot ðŸ“¸")})});