let GAME_={status:!1,end:!1,active:!1,score:0,combo:0,gamesPlayed:0,bestResult:window.localStorage.getItem("bestResult")?window.localStorage.getItem("bestResult"):0,newRecord:!1,designPalette:0,screenshot:{service:!0,enable:!1,frames:0,callback:null,blob:null},botMode:!1,zoomOut:{service:!0,enable:!1,frames:0,finished:!1}};const colorDesign=[[30,70,50],[120,80,60],[224,68,62],[251,50,60],[339,62,48],[231,50,47],[165,30,68]],boxSize={x:3,y:1,z:3,range:10},c_width=10,cameraPos={width:10,height:window.innerHeight/window.innerWidth*10,near:1,far:100,size:window.innerWidth>700?1:2};let world,scene,camera,renderer,fncStart,stackBoxArr=[],outBoxArr=[];function playConfetti(e,t){party.confetti(party.Rect.fromScreen(),{count:party.variation.range(e||60,t||80)})}function playBot(e,t,o=!0){GAME_.botMode=!0;setInterval(()=>{try{const t=stackBoxArr[stackBoxArr.length-1],s=stackBoxArr[stackBoxArr.length-2];let n=t.direction,r=t.threejs.position[n]-s.threejs.position[n],a=Math.abs(r),i="x"===n?t.width:t.depth;const c=(i-a)/i;c>=(e||.95)&&(fncStart(),o&&console.log(c))}catch(e){fncStart()}},t||20)}window.addEventListener("load",()=>{let e=document.querySelector(".result-area"),t=document.querySelector(".point-result"),o=document.querySelector(".score-tab"),s=document.querySelector(".combo-strike"),n=document.querySelector(".combo-extra-point"),r=document.querySelector("#click-event"),a=document.querySelector("#record-share");function i(e){scene.background=new THREE.Color(h(colorDesign[GAME_.designPalette][0]+120+stackBoxArr.length,colorDesign[GAME_.designPalette][1],colorDesign[GAME_.designPalette][2]))}function c(e){t.innerHTML=e}function l(e,t,o,s,n){const r=d(e,boxSize.y*stackBoxArr.length,t,o,s,!1);r.direction=n,r.positive=!0,stackBoxArr.push(r)}function d(e,t,o,s,n,r=!1){let a=r?4*(stackBoxArr.length-1):4*stackBoxArr.length;const i=new THREE.Color(h(colorDesign[GAME_.designPalette][0]+a,colorDesign[GAME_.designPalette][1],colorDesign[GAME_.designPalette][2])),c=new THREE.BoxGeometry(s,boxSize.y,n),l=new THREE.MeshLambertMaterial({color:i}),d=new THREE.Mesh(c,l);d.position.set(e,t,o);const m=new CANNON.Box(new CANNON.Vec3(s/2,boxSize.y/2,n/2));let A=r?5:0;const E=new CANNON.Body({mass:A,shape:m});return E.position.set(e,t,o),world.addBody(E),scene.add(d),{threejs:d,geometry:c,material:l,cannonjs:E,x:e,y:t,z:o,width:s,depth:n}}function h(e,t,o){o=o>101?100:o,o/=100;const s=t*Math.min(o,1-o)/100,n=t=>{const n=(t+e/30)%12,r=o-s*Math.max(Math.min(n-3,9-n,1),-1);return Math.round(255*r).toString(16).padStart(2,"0")};return`#${n(0)}${n(8)}${n(4)}`}function m(){camera.right=cameraPos.width/cameraPos.size,camera.left=cameraPos.width/-cameraPos.size,camera.top=cameraPos.height/cameraPos.size,camera.bottom=cameraPos.height/-cameraPos.size,camera.updateProjectionMatrix()}(world=new CANNON.World).gravity.set(0,-9.8,0),world.broadphase=new CANNON.NaiveBroadphase,world.solver.interations=40,c(GAME_.bestResult),scene=new THREE.Scene,i(),l(0,0,boxSize.x,boxSize.z,"x");const A=new THREE.AmbientLight(16777215,.6);scene.add(A);const E=new THREE.DirectionalLight(16777215,.6);function p(){if(GAME_.end)stackBoxArr[stackBoxArr.length-1].threejs.position.copy(stackBoxArr[stackBoxArr.length-1].cannonjs.position),stackBoxArr[stackBoxArr.length-1].threejs.quaternion.copy(stackBoxArr[stackBoxArr.length-1].cannonjs.quaternion),GAME_.zoomOut.enable&&(cameraPos.size-=.02,m(),GAME_.zoomOut.frames++,GAME_.zoomOut.frames>=20&&(GAME_.zoomOut.enable=!1,GAME_.zoomOut.frames=0,GAME_.zoomOut.finished=!0));else{const e=stackBoxArr[stackBoxArr.length-1],t=e.positive?.15:-.15;e.threejs.position[e.direction]>=boxSize.range-5&&(e.positive=!1),e.threejs.position[e.direction]<=-(boxSize.range-5)&&(e.positive=!0),e.threejs.position[e.direction]+=t,e.cannonjs.position[e.direction]+=t,camera.position.y<boxSize.y*(stackBoxArr.length-2)+4&&(camera.position.y+=t)}world.step(1/60),outBoxArr.forEach(e=>{e.threejs.position.copy(e.cannonjs.position),e.threejs.quaternion.copy(e.cannonjs.quaternion)}),renderer.render(scene,camera),GAME_.screenshot.enable&&(GAME_.screenshot.frames>=5?GAME_.zoomOut.finished&&(DrawCanvasCopy(renderer.domElement,e=>{e.fillStyle="rgba(0, 0, 0, 0.2)",e.fillRect(0,0,e.canvas.width,e.canvas.height),e.fillStyle="#ffffff",e.font="32px monospace";var t="NEW RECORD",o=e.measureText(t).width;if(e.fillText(t,e.canvas.width/2-o/2,e.canvas.height/2-100),e.font="bold 64px monospace",t=GAME_.score,o=e.measureText(t).width,e.fillText(t,e.canvas.width/2-o/2,e.canvas.height/2+50),GAME_.botMode){e.save(),e.translate(e.canvas.width/2,e.canvas.height/2+50),e.rotate(-Math.PI/8);e.fillStyle="rgba(255, 0, 0, 0.6)",e.font="bold 64px monospace";t="FAKE",o=e.measureText(t).width,e.fillText(t,-o/2,0),e.strokeStyle="rgba(255, 0, 0, 0.5)",e.lineWidth=5,e.strokeRect(-(o/2+10),-51.152,o+20,56.152),e.restore()}},e=>{const t=document.createElement("img"),o=URL.createObjectURL(e);t.onload=(()=>{URL.revokeObjectURL(o)}),t.src=o,GAME_.screenshot.blob=e,GAME_.screenshot.callback(t)}),GAME_.screenshot.enable=!1,GAME_.screenshot.frames=0):GAME_.screenshot.frames++)}E.position.set(10,20,0),scene.add(E),(camera=new THREE.OrthographicCamera(cameraPos.width/-cameraPos.size,cameraPos.width/cameraPos.size,cameraPos.height/cameraPos.size,cameraPos.height/-cameraPos.size,cameraPos.near,cameraPos.far)).position.set(4,4,4),camera.lookAt(0,0,0),(renderer=new THREE.WebGLRenderer({antialias:!0})).setSize(window.innerWidth,window.innerHeight),renderer.render(scene,camera),renderer.domElement.id="Stackblock",document.body.appendChild(renderer.domElement),fncStart=(()=>{if(GAME_.status){let r,h;const m=stackBoxArr[stackBoxArr.length-1],A=stackBoxArr[stackBoxArr.length-2];let E=m.direction,p=m.threejs.position[E]-A.threejs.position[E],u=Math.abs(p),w="x"===E?m.width:m.depth,x=w-u;if(x>0){const e=x/w;u<.2?([9,19,29,39,49].includes(GAME_.combo)&&(n.classList.add("active"),setTimeout(()=>{n.classList.remove("active")},1100),GAME_.score+=10),GAME_.combo+=1,s.innerHTML=`x${GAME_.combo}`,s.classList.add("open"),setTimeout(()=>{s.classList.remove("open")},700)):GAME_.combo&&(GAME_.combo=0),r="x"===E?x:m.width,h="z"===E?x:m.depth,m.width=r,m.depth=h,m.threejs.scale[E]=e,m.threejs.position[E]-=p/2,m.cannonjs.position[E]-=p/2;const t=new CANNON.Box(new CANNON.Vec3(r/2,boxSize.y/2,h/2));if(m.cannonjs.shapes=[],m.cannonjs.addShape(t),u>=.01){let e=Math.sign(p)*(x/2+u/2);const t={x:"x"===E?m.threejs.position.x+e:m.threejs.position.x,z:"z"===E?m.threejs.position.z+e:m.threejs.position.z,width:"x"===E?u:r,depth:"z"===E?u:h};!function(e,t,o,s){const n=d(e,boxSize.y*(stackBoxArr.length-1),t,o,s,!0);outBoxArr.push(n)}(t.x,t.z,t.width,t.depth)}l("x"===E?m.threejs.position.x:-(boxSize.range-1),"z"===E?m.threejs.position.z:-(boxSize.range-1),r,h,"x"===E?"z":"x"),GAME_.score++,i(),c(GAME_.score)}else{GAME_.end=!0,world.remove(m.cannonjs);const s=new CANNON.Box(new CANNON.Vec3(m.width/2,boxSize.y/2,m.depth/2));let n=5;const r=new CANNON.Body({mass:n,shape:s});r.position.set(m.threejs.position.x,m.threejs.position.y,m.threejs.position.z),world.addBody(r),m.cannonjs=r,e.classList.toggle("disable"),t.classList.toggle("active"),GAME_.status=!1,GAME_.score>GAME_.bestResult&&(playConfetti(),GAME_.botMode||(GAME_.bestResult=GAME_.score,window.localStorage.setItem("bestResult",GAME_.score)),o.classList.add("new"),GAME_.newRecord=!0,GAME_.screenshot.service&&(GAME_.screenshot.callback=(e=>{a.replaceChild(e,a.querySelector("img")),a.classList.add("display")}),GAME_.screenshot.enable=!0)),GAME_.zoomOut.service&&(GAME_.zoomOut.enable=!0);let i=localStorage.getItem("installDismissed")||!1;!enableDownload||"false"!=i&&i||(document.querySelector("#pwa-install").classList.add("display"),GAME_.gamesPlayed>0&&document.querySelector("#pwa-dismiss-btn").classList.add("display")),GAME_.gamesPlayed++}}else GAME_.active?(GAME_.designPalette=Math.floor(Math.random()*colorDesign.length),cameraPos.size=window.innerWidth>700?1:2,m(),camera.position.set(4,4,4),camera.lookAt(0,0,0),GAME_.zoomOut.finished=!1,stackBoxArr.forEach(e=>{scene.remove(e.threejs),e.geometry.dispose(),e.material.dispose(),world.removeBody(e.cannonjs)}),outBoxArr.forEach(e=>{scene.remove(e.threejs),e.geometry.dispose(),e.material.dispose(),world.removeBody(e.cannonjs)}),stackBoxArr=[],outBoxArr=[],GAME_.score=0,GAME_.combo=0,i(),l(0,0,boxSize.x,boxSize.z,"x"),document.querySelector("#pwa-install").classList.remove("display"),a.classList.remove("display")):(renderer.setAnimationLoop(p),GAME_.active=!0,o.querySelector(".score").innerHTML="SCORE"),c(GAME_.score),l(0,0,boxSize.x,boxSize.z,"z"),e.classList.toggle("disable"),t.classList.toggle("active"),GAME_.newRecord&&(GAME_.newRecord=!1,o.classList.remove("new")),GAME_.status=!0,GAME_.end=!1});let u="ontouchstart"in window||navigator.msMaxTouchPoints?"touchstart":"mousedown";r.addEventListener(u,fncStart);let w=!0;window.addEventListener("keydown",function(e){32!==e.keyCode&&40!==e.keyCode&&" "!==e.key||(e.preventDefault(),w&&(w=!1,fncStart()))}),window.addEventListener("keyup",function(e){32!==e.keyCode&&40!==e.keyCode&&" "!==e.key||(w=!0)}),a.addEventListener(u,async()=>{await Blob2Share(GAME_.screenshot.blob)||Blob2Download(GAME_.screenshot.blob)})});