const log=console.log;let GAME_={status:!1,end:!1,active:!1,score:0,combo:0,bestResult:window.localStorage.getItem("bestResult")?window.localStorage.getItem("bestResult"):0,newRecord:!1,designPalette:0};const colorDesign=[[30,70,50],[120,80,60],[224,68,62],[251,50,60],[339,62,48],[231,50,47]],boxSize={x:3,y:1,z:3,range:10},c_width=10,cameraPos={width:10,height:10*(window.innerHeight/window.innerWidth),near:1,far:100,size:window.innerWidth>700?1:2};let world,scene,camera,renderer,fncStart,stackBoxArr=[],outBoxArr=[];function playConfetti(e,t){party.confetti(party.Rect.fromScreen(),{count:party.variation.range(e||60,t||80)})}function playBot(e,t,o=!0){setInterval(()=>{let t=stackBoxArr[stackBoxArr.length-1],r=stackBoxArr[stackBoxArr.length-2],s=t.direction,n=t.threejs.position[s]-r.threejs.position[s],i="x"===s?t.width:t.depth,a=(i-Math.abs(n))/i;a>=(e||.9)&&(fncStart(),o&&console.log(a))},t||20)}window.addEventListener("load",()=>{let e=document.querySelector(".result-area"),t=document.querySelector(".point-result"),o=document.querySelector(".score-tab"),r=document.querySelector(".combo-strike"),s=document.querySelector(".combo-extra-point");function n(e){scene.background=new THREE.Color(h(colorDesign[GAME_.designPalette][0]+120+stackBoxArr.length,colorDesign[GAME_.designPalette][1],colorDesign[GAME_.designPalette][2]))}function i(e){t.innerHTML=e}function a(e,t,o,r){let s=boxSize.y*(stackBoxArr.length-1),n=d(e,s,t,o,r,!0);outBoxArr.push(n)}function c(){world.step(1/60),outBoxArr.forEach(e=>{e.threejs.position.copy(e.cannonjs.position),e.threejs.quaternion.copy(e.cannonjs.quaternion)})}function l(e,t,o,r,s){let n=boxSize.y*stackBoxArr.length,i=d(e,n,t,o,r,!1);i.direction=s,i.positive=!0,stackBoxArr.push(i)}function d(e,t,o,r,s,n=!1){let i=n?(stackBoxArr.length-1)*4:4*stackBoxArr.length,a=new THREE.Color(h(colorDesign[GAME_.designPalette][0]+i,colorDesign[GAME_.designPalette][1],colorDesign[GAME_.designPalette][2])),c=new THREE.BoxGeometry(r,boxSize.y,s),l=new THREE.MeshLambertMaterial({color:a}),d=new THREE.Mesh(c,l);d.position.set(e,t,o);let $=new CANNON.Box(new CANNON.Vec3(r/2,boxSize.y/2,s/2)),x=new CANNON.Body({mass:n?5:0,shape:$});return x.position.set(e,t,o),world.addBody(x),scene.add(d),{threejs:d,geometry:c,material:l,cannonjs:x,x:e,y:t,z:o,width:r,depth:s}}function h(e,t,o){o=o>101?100:o,o/=100;let r=t*Math.min(o,1-o)/100,s=t=>{let s=(t+e/30)%12,n=o-r*Math.max(Math.min(s-3,9-s,1),-1);return Math.round(255*n).toString(16).padStart(2,"0")};return`#${s(0)}${s(8)}${s(4)}`}function $(){GAME_.designPalette=Math.floor(Math.random()*colorDesign.length),camera.position.set(4,4,4),camera.lookAt(0,0,0),stackBoxArr.forEach(e=>{scene.remove(e.threejs),e.geometry.dispose(),e.material.dispose(),world.removeBody(e.cannonjs)}),outBoxArr.forEach(e=>{scene.remove(e.threejs),e.geometry.dispose(),e.material.dispose(),world.removeBody(e.cannonjs)}),stackBoxArr=[],outBoxArr=[],GAME_.score=0,GAME_.combo=0,n(),l(0,0,boxSize.x,boxSize.z,"x")}(world=new CANNON.World).gravity.set(0,-9.8,0),world.broadphase=new CANNON.NaiveBroadphase,world.solver.interations=40,i(GAME_.bestResult),scene=new THREE.Scene,n(),l(0,0,boxSize.x,boxSize.z,"x");let x=new THREE.AmbientLight(16777215,.6);scene.add(x);let p=new THREE.DirectionalLight(16777215,.6);function A(){if(GAME_.end)stackBoxArr[stackBoxArr.length-1].threejs.position.copy(stackBoxArr[stackBoxArr.length-1].cannonjs.position),stackBoxArr[stackBoxArr.length-1].threejs.quaternion.copy(stackBoxArr[stackBoxArr.length-1].cannonjs.quaternion);else{let e=stackBoxArr[stackBoxArr.length-1],t=e.positive?.15:-.15;e.threejs.position[e.direction]>=boxSize.range-5&&(e.positive=!1),e.threejs.position[e.direction]<=-(boxSize.range-5)&&(e.positive=!0),e.threejs.position[e.direction]+=t,e.cannonjs.position[e.direction]+=t,camera.position.y<boxSize.y*(stackBoxArr.length-2)+4&&(camera.position.y+=t)}c(),renderer.render(scene,camera)}p.position.set(10,20,0),scene.add(p),(camera=new THREE.OrthographicCamera(-(cameraPos.width/cameraPos.size),cameraPos.width/cameraPos.size,cameraPos.height/cameraPos.size,-(cameraPos.height/cameraPos.size),cameraPos.near,cameraPos.far)).position.set(4,4,4),camera.lookAt(0,0,0),(renderer=new THREE.WebGLRenderer({antialias:!0})).setSize(window.innerWidth,window.innerHeight),renderer.render(scene,camera),document.body.appendChild(renderer.domElement),fncStart=()=>{if(GAME_.status){let c,d,h=stackBoxArr[stackBoxArr.length-1],x=stackBoxArr[stackBoxArr.length-2],p=h.direction,g=h.threejs.position[p]-x.threejs.position[p],m=Math.abs(g),u="x"===p?h.width:h.depth,_=u-m;if(_>0){let w=_/u;w>=.9?([9,19,29,39,49].includes(GAME_.combo)&&(s.classList.add("active"),setTimeout(()=>{s.classList.remove("active")},1100),GAME_.score+=10),GAME_.combo+=1,r.innerHTML=`x${GAME_.combo}`,r.classList.add("open"),setTimeout(()=>{r.classList.remove("open")},700)):GAME_.combo&&(GAME_.combo=0),c="x"===p?_:h.width,d="z"===p?_:h.depth,h.width=c,h.depth=d,h.threejs.scale[p]=w,h.threejs.position[p]-=g/2,h.cannonjs.position[p]-=g/2;let y=new CANNON.Box(new CANNON.Vec3(c/2,boxSize.y/2,d/2));if(h.cannonjs.shapes=[],h.cannonjs.addShape(y),m>=.01){let b=Math.sign(g)*(_/2+m/2),f={x:"x"===p?h.threejs.position.x+b:h.threejs.position.x,z:"z"===p?h.threejs.position.z+b:h.threejs.position.z,width:"x"===p?m:c,depth:"z"===p?m:d};a(f.x,f.z,f.width,f.depth)}let B="x"===p?h.threejs.position.x:-(boxSize.range-1),E;l(B,"z"===p?h.threejs.position.z:-(boxSize.range-1),c,d,"x"===p?"z":"x"),GAME_.score++,n(),i(GAME_.score)}else{GAME_.end=!0,world.remove(h.cannonjs);let M=new CANNON.Box(new CANNON.Vec3(h.width/2,boxSize.y/2,h.depth/2)),k=5,z=new CANNON.Body({mass:k,shape:M});z.position.set(h.threejs.position.x,h.threejs.position.y,h.threejs.position.z),world.addBody(z),h.cannonjs=z,e.classList.toggle("disable"),t.classList.toggle("active"),GAME_.status=!1,GAME_.score>GAME_.bestResult&&(playConfetti(),GAME_.bestResult=GAME_.score,window.localStorage.setItem("bestResult",GAME_.score),o.classList.add("new"),GAME_.newRecord=!0),enableDownload&&document.querySelector("#pwa-install").classList.add("display")}}else GAME_.active?$():(renderer.setAnimationLoop(A),GAME_.active=!0),i(GAME_.score),l(0,0,boxSize.x,boxSize.z,"z"),e.classList.toggle("disable"),t.classList.toggle("active"),document.querySelector("#pwa-install").classList.remove("display"),GAME_.newRecord&&(GAME_.newRecord=!1,o.classList.remove("new")),GAME_.status=!0,GAME_.end=!1};let g="ontouchstart"in window||navigator.msMaxTouchPoints?"touchstart":"mousedown";window.addEventListener(g,e=>{e.target.className.split(" ").some(e=>/pwa-.*/.test(e))||fncStart()});let m=!0;window.addEventListener("keydown",function(e){(32===e.keyCode||40===e.keyCode||" "===e.key)&&(e.preventDefault(),m&&(m=!1,fncStart()))}),window.addEventListener("keyup",function(e){(32===e.keyCode||40===e.keyCode||" "===e.key)&&(m=!0)})});