let MEMORY_={localStorage:{bestResult:"bestResult",achievement:"st-ach",installNo:"installDismissed"}},GAME_={platform:navigator.userAgent.match(/(iPad|iPhone|iPod)/g)?"ios":navigator.userAgent.match(/(Android)/g)?"android":navigator.userAgent.match(/(Windows)/g)?"windows":navigator.userAgent.match(/(Mac)/g)?"mac":navigator.userAgent.match(/(Linux)/g)?"linux":"unknown",status:!1,fpsCtrl:{forceLag:!1,fps:60,mFps:0,fpsInterval:0,now:0,then:0,delta:0,lagWarning:{enable:!0,lastWarning:0,frames:0,framesMax:180}},end:!1,active:!1,score:0,combo:0,gamesPlayed:0,bestResult:window.localStorage.getItem(MEMORY_.localStorage.bestResult)??0,newRecord:!1,designPalette:0,screenshot:{service:!0,enable:!1,frames:0,framesMax:5,callback:null,blob:null},botMode:!1,confetti:{range:[30,50]},zoomOut:{service:!0,enable:!1,frames:0,framesMax:20,finished:!1},colorDesign:[[30,70,50],[120,80,60],[224,68,62],[251,50,60],[339,62,48],[231,50,47],[165,30,68]],boxSize:{x:3,y:1,z:3,range:10},c_width:10,cameraPos:{width:10,height:10*(window.innerHeight/window.innerWidth),near:1,far:100,size:window.innerWidth>700?1:2},world:void 0,scene:void 0,camera:void 0,renderer:void 0,fncStart:void 0,stackBoxArr:[],outBoxArr:[],achievement:JSON.parse(window.localStorage.getItem(MEMORY_.localStorage.achievement))??{default:{message:"Default"},length:0},achievementUnlockMin:4,soundTrack:{menu:{name:"menu",current:null,next:null,list:["Hello_its_Me_00_Pix_64kbps.mp3"]},game:{name:"game",current:[null,null,null],next:[null,null,null],list:[["Begin_Your_Journey_","_Pix_64kbps.mp3"],["Dark_Sanctum_","_Uname_World_00kps.mp3"],]},other:{name:"other",list:[["Start_Game_effect.mp3","start"],["End_Game_effect.mp3","end"],["New_Record_effect.mp3","newRecord"],]},load:null,next:null}};function playConfetti(e,t){party.confetti(party.Rect.fromScreen(),{count:party.variation.range(e||60,t||80)})}function playBot(e,t,r=!0){GAME_.unlockAchieve("cheater","Faker, cheater... \uD83E\uDD2C"),GAME_.botMode=!0,setInterval(()=>{try{let t=GAME_.stackBoxArr[GAME_.stackBoxArr.length-1],o=GAME_.stackBoxArr[GAME_.stackBoxArr.length-2],n=t.direction,a=t.threejs.position[n]-o.threejs.position[n],s="x"===n?t.width:t.depth,i=(s-Math.abs(a))/s;i>=(e||.95)&&(fncStart(),r&&console.log(i))}catch(c){fncStart()}},t||20)}GAME_.soundTrack.load=(e,t)=>{let r,o=t.constructor===Array?t[Math.floor(Math.random()*t.length)]:t;if("game"==e){r=[null,null,null];for(let n=0;n<3;n++)r[n]=new Audio(`./music/${e}/${o[0]}0${n}${o[1]}`),r[n].loop=!0,r[n].currentTime=0,r[n].addEventListener("ended",()=>{this.currentTime=0,this.play()},!1)}else(r=new Audio(`./music/${e}/${o}`)).currentTime=0,"other"!=e&&(r.loop=!0,r.addEventListener("ended",()=>{this.currentTime=0,this.play()},!1));return r},GAME_.soundTrack.next=e=>{e.current=e.next.slice(0),e.next=null,e.next=GAME_.soundTrack.load(e.name,e.list)},GAME_.soundTrack.menu.current=GAME_.soundTrack.load("menu",GAME_.soundTrack.menu.list),GAME_.soundTrack.game.current=GAME_.soundTrack.load("game",GAME_.soundTrack.game.list),GAME_.soundTrack.game.next=GAME_.soundTrack.load("game",GAME_.soundTrack.game.list),GAME_.soundTrack.other.list.forEach(e=>{GAME_.soundTrack.other[e[1]]=GAME_.soundTrack.load("other",e[0])}),window.addEventListener("load",()=>{//!TODO CHANGE IT
GAME_.soundTrack.menu.current.play(),"ios"===GAME_.platform&&navigator.userAgent.match(/(Safari)/g)&&(document.querySelector(".pwa-install-title").innerText="Apple StackBlock.io",document.querySelector(".pwa-install-description").innerHTML='Download the APP in <img src="https://help.apple.com/assets/64F2669B7BEF8AE318002477/64F266A17BEF8AE3180024A8/en_US/d26fe35d3438fe81179a80c2b6c9b0c9.png" width="10" originalimagename="GlobalArt/IL_ShareBlue.png">',document.querySelector(".pwa-install-button").innerHTML=`
        <a id="pwa-dismiss-btn" class="pwa-install-btn">Not now</a>
        <a id="pwa-install-btn" class="pwa-install-btn-apple" href="https://support.apple.com/en-gb/guide/iphone/iph42ab2f3a7/ios#iph4f9a47bbc">See more</a>
        `);let e=document.querySelector(".result-area"),t=document.querySelector(".point-result"),r=document.querySelector(".score-tab"),o=document.querySelector(".combo-strike"),n=document.querySelector(".combo-extra-point"),a=document.querySelector("#click-event"),s=document.querySelector("#record-share");function i(e=!1){let t=E(GAME_.colorDesign[GAME_.designPalette][0]+120+GAME_.stackBoxArr.length,GAME_.colorDesign[GAME_.designPalette][1],GAME_.colorDesign[GAME_.designPalette][2]);GAME_.scene.background=new THREE.Color(t),e&&(t=E(GAME_.colorDesign[GAME_.designPalette][0]+120+GAME_.stackBoxArr.length,GAME_.colorDesign[GAME_.designPalette][1],10)),document.querySelector('meta[name="theme-color"]').setAttribute("content",t),document.body.style.backgroundColor=t,"windows"===GAME_.platform&&document.querySelector('meta[name="msapplication-TileColor"]').setAttribute("content",t)}function c(e){t.innerHTML=e}function l(e,t,r,o){let n=GAME_.boxSize.y*(GAME_.stackBoxArr.length-1),a=d(e,n,t,r,o,!0);GAME_.outBoxArr.push(a)}function A(){GAME_.world.step(1/60),GAME_.outBoxArr.forEach(e=>{e.threejs.position.copy(e.cannonjs.position),e.threejs.quaternion.copy(e.cannonjs.quaternion)})}function M(e,t,r,o,n){let a=GAME_.boxSize.y*GAME_.stackBoxArr.length,s=d(e,a,t,r,o,!1);s.direction=n,s.positive=!0,GAME_.stackBoxArr.push(s)}function d(e,t,r,o,n,a=!1){let s=a?(GAME_.stackBoxArr.length-1)*4:4*GAME_.stackBoxArr.length,i=new THREE.Color(E(GAME_.colorDesign[GAME_.designPalette][0]+s,GAME_.colorDesign[GAME_.designPalette][1],GAME_.colorDesign[GAME_.designPalette][2])),c=new THREE.BoxGeometry(o,GAME_.boxSize.y,n),l=new THREE.MeshLambertMaterial({color:i}),A=new THREE.Mesh(c,l);A.position.set(e,t,r);let M=new CANNON.Box(new CANNON.Vec3(o/2,GAME_.boxSize.y/2,n/2)),d=new CANNON.Body({mass:a?5:0,shape:M});return d.position.set(e,t,r),GAME_.world.addBody(d),GAME_.scene.add(A),{threejs:A,geometry:c,material:l,cannonjs:d,x:e,y:t,z:r,width:o,depth:n}}function E(e,t,r){r=r>101?100:r,r/=100;let o=t*Math.min(r,1-r)/100,n=t=>{let n=(t+e/30)%12,a=r-o*Math.max(Math.min(n-3,9-n,1),-1);return Math.round(255*a).toString(16).padStart(2,"0")};return`#${n(0)}${n(8)}${n(4)}`}function G(){GAME_.camera.right=GAME_.cameraPos.width/GAME_.cameraPos.size,GAME_.camera.left=-(GAME_.cameraPos.width/GAME_.cameraPos.size),GAME_.camera.top=GAME_.cameraPos.height/GAME_.cameraPos.size,GAME_.camera.bottom=-(GAME_.cameraPos.height/GAME_.cameraPos.size),GAME_.camera.updateProjectionMatrix()}function m(){return"now"in window?now():"now"in performance&&"performance"in window?performance.now():Date.now()}function p(){let e=document.querySelector('meta[name="viewport"]').getAttribute("content");"matchMedia"in window?window.matchMedia("(orientation: landscape)").matches?document.querySelector('meta[name="viewport"]').setAttribute("content",e.replace("contain","cover")):document.querySelector('meta[name="viewport"]').setAttribute("content",e.replace("cover","contain")):window.innerHeight>window.innerWidth?document.querySelector('meta[name="viewport"]').setAttribute("content",e.replace("contain","cover")):document.querySelector('meta[name="viewport"]').setAttribute("content",e.replace("cover","contain"))}function u(){GAME_.cameraPos.height=GAME_.c_width*(window.innerHeight/window.innerWidth),GAME_.cameraPos.size=window.innerWidth>700?1:2,G(),GAME_.renderer.setSize(window.innerWidth,window.innerHeight),GAME_.renderer.render(GAME_.scene,GAME_.camera)}function h(e){document.querySelector("#noti-popup").classList.remove("display"),document.querySelector("#noti-popup-text").innerHTML=e,document.querySelector("#noti-popup").classList.add("display"),setTimeout(()=>document.querySelector("#noti-popup").classList.remove("display"),5200)}GAME_.unlockAchieve=(e,t)=>{e in GAME_.achievement||(GAME_.achievement[e]={message:t},GAME_.achievement.length++,GAME_.achievement.length>GAME_.achievementUnlockMin&&document.body.classList.add("unlocked-achie"),document.querySelector("#achie-text .message").innerHTML=t,document.querySelector("#achie-popup").classList.remove("display"),document.querySelector("#achie-popup").classList.add("display"),setTimeout(()=>document.querySelector("#noti-popup").classList.remove("display"),5200),localStorage.setItem(MEMORY_.localStorage.achievement,JSON.stringify(GAME_.achievement)))};let $=GAME_.unlockAchieve;function g(){GAME_.designPalette=Math.floor(Math.random()*GAME_.colorDesign.length),GAME_.cameraPos.size=window.innerWidth>700?1:2,G(),GAME_.camera.position.set(4,4,4),GAME_.camera.lookAt(0,0,0),GAME_.zoomOut.finished=!1,GAME_.stackBoxArr.forEach(e=>{GAME_.scene.remove(e.threejs),e.geometry.dispose(),e.material.dispose(),GAME_.world.removeBody(e.cannonjs)}),GAME_.outBoxArr.forEach(e=>{GAME_.scene.remove(e.threejs),e.geometry.dispose(),e.material.dispose(),GAME_.world.removeBody(e.cannonjs)}),GAME_.stackBoxArr=[],GAME_.outBoxArr=[],GAME_.score=0,GAME_.combo=0,i(),M(0,0,GAME_.boxSize.x,GAME_.boxSize.z,"x"),document.querySelector("#pwa-install").classList.remove("display"),s.classList.remove("display"),document.querySelector("#noti-popup").classList.remove("display")}console.log(GAME_.achievement.length,GAME_.achievementUnlockMin),GAME_.achievement.length>GAME_.achievementUnlockMin&&document.body.classList.add("unlocked-achie"),GAME_.world=new CANNON.World,GAME_.world.gravity.set(0,-9.8,0),GAME_.world.broadphase=new CANNON.NaiveBroadphase,GAME_.world.solver.interations=40,c(GAME_.bestResult),GAME_.scene=new THREE.Scene,i(hslDark=!0),M(0,0,GAME_.boxSize.x,GAME_.boxSize.z,"x");let f=new THREE.AmbientLight(16777215,.6);GAME_.scene.add(f);let b=new THREE.DirectionalLight(16777215,.6);function y(){if(GAME_.end)GAME_.stackBoxArr[GAME_.stackBoxArr.length-1].threejs.position.copy(GAME_.stackBoxArr[GAME_.stackBoxArr.length-1].cannonjs.position),GAME_.stackBoxArr[GAME_.stackBoxArr.length-1].threejs.quaternion.copy(GAME_.stackBoxArr[GAME_.stackBoxArr.length-1].cannonjs.quaternion),GAME_.zoomOut.enable&&(GAME_.cameraPos.size-=.02,G(),GAME_.zoomOut.frames++,GAME_.zoomOut.frames>=GAME_.zoomOut.framesMax&&(GAME_.zoomOut.enable=!1,GAME_.zoomOut.frames=0,GAME_.zoomOut.finished=!0));else{let e=GAME_.stackBoxArr[GAME_.stackBoxArr.length-1],t=e.positive?.15:-.15;e.threejs.position[e.direction]>=GAME_.boxSize.range-5&&(e.positive=!1),e.threejs.position[e.direction]<=-(GAME_.boxSize.range-5)&&(e.positive=!0),e.threejs.position[e.direction]+=t,e.cannonjs.position[e.direction]+=t,GAME_.camera.position.y<GAME_.boxSize.y*(GAME_.stackBoxArr.length-2)+4&&(GAME_.camera.position.y+=t)}A(),GAME_.renderer.render(GAME_.scene,GAME_.camera),GAME_.screenshot.enable&&(GAME_.screenshot.frames>=GAME_.screenshot.framesMax?GAME_.zoomOut.finished&&(DrawCanvasCopy(GAME_.renderer.domElement,e=>{e.fillStyle="rgba(0, 0, 0, 0.2)",e.fillRect(0,0,e.canvas.width,e.canvas.height),e.fillStyle="#ffffff",e.font="32px monospace";var t="NEW RECORD",r=e.measureText(t).width;if(e.fillText(t,e.canvas.width/2-r/2,e.canvas.height/2-100),e.font="bold 64px monospace",t=GAME_.score,r=e.measureText(t).width,e.fillText(t,e.canvas.width/2-r/2,e.canvas.height/2+50),GAME_.botMode){e.save(),e.translate(e.canvas.width/2,e.canvas.height/2+50),e.rotate(-Math.PI/8),e.fillStyle="rgba(255, 0, 0, 0.6)",e.font="bold 64px monospace";t="FAKE",r=e.measureText(t).width,e.fillText(t,-(r/2),0),e.strokeStyle="rgba(255, 0, 0, 0.5)",e.lineWidth=5,e.strokeRect(-(r/2+10),-51.152,r+20,56.152),e.restore()}},e=>{let t=document.createElement("img"),r=URL.createObjectURL(e);t.onload=()=>{URL.revokeObjectURL(r)},t.src=r,GAME_.screenshot.blob=e,GAME_.screenshot.callback(t)}),GAME_.screenshot.enable=!1,GAME_.screenshot.frames=0):GAME_.screenshot.frames++)}function x(){requestAnimationFrame(x),GAME_.fpsCtrl.now=m(),GAME_.fpsCtrl.elapsed=GAME_.fpsCtrl.now-GAME_.fpsCtrl.then,GAME_.fpsCtrl.elapsed>GAME_.fpsCtrl.fpsInterval&&(GAME_.fpsCtrl.mFps=Math.round(1e3/GAME_.fpsCtrl.elapsed)-(GAME_.fpsCtrl.forceLag?30:0),GAME_.fpsCtrl.mFps<GAME_.fpsCtrl.fps/2?GAME_.fpsCtrl.lagWarning.frames>=GAME_.fpsCtrl.lagWarning.framesMax?(GAME_.fpsCtrl.lagWarning.lastWarning+3e4<GAME_.fpsCtrl.now&&(GAME_.fpsCtrl.lagWarning.lastWarning=GAME_.fpsCtrl.now,GAME_.fpsCtrl.lagWarning.enable=!0),GAME_.fpsCtrl.lagWarning.enable&&(GAME_.fpsCtrl.lagWarning.enable=!1,h("May be laggy. Try to close other apps"),GAME_.fpsCtrl.lagWarning.frames=0)):GAME_.fpsCtrl.lagWarning.frames++:GAME_.fpsCtrl.lagWarning.frames=0,GAME_.fpsCtrl.then=GAME_.fpsCtrl.now-GAME_.fpsCtrl.elapsed%GAME_.fpsCtrl.fpsInterval,y())}b.position.set(10,20,0),GAME_.scene.add(b),GAME_.camera=new THREE.OrthographicCamera(-(GAME_.cameraPos.width/GAME_.cameraPos.size),GAME_.cameraPos.width/GAME_.cameraPos.size,GAME_.cameraPos.height/GAME_.cameraPos.size,-(GAME_.cameraPos.height/GAME_.cameraPos.size),GAME_.cameraPos.near,GAME_.cameraPos.far),GAME_.camera.position.set(4,4,4),GAME_.camera.lookAt(0,0,0),GAME_.renderer=new THREE.WebGLRenderer({antialias:!0}),GAME_.renderer.setSize(window.innerWidth,window.innerHeight),GAME_.renderer.render(GAME_.scene,GAME_.camera),GAME_.renderer.domElement.id="Stackblock",document.body.querySelector("#game").appendChild(GAME_.renderer.domElement),"deviceMemory"in navigator&&(navigator.deviceMemory<=32?GAME_.confetti.range=[10*Math.log2(navigator.deviceMemory),10*Math.log2(navigator.deviceMemory)+20,].map(Math.round):GAME_.confetti.range=[50,70]),fncStart=()=>{if(GAME_.status){let a,A,d=GAME_.stackBoxArr[GAME_.stackBoxArr.length-1],E=GAME_.stackBoxArr[GAME_.stackBoxArr.length-2],G=d.direction,p=d.threejs.position[G]-E.threejs.position[G],u=Math.abs(p),h="x"===G?d.width:d.depth,f=h-u;if(f>0){let b=f/h;if(u<.2){switch([9,19,29,39,49].includes(GAME_.combo)&&(n.classList.add("active"),setTimeout(()=>{n.classList.remove("active")},1100),GAME_.score+=10),GAME_.combo+=1,GAME_.combo){case 10:$("combo","Combo Master");break;case 20:$("combo2","Combo Super Master");break;case 30:$("combo3","Combo Super Master God")}o.innerHTML=`x${GAME_.combo}`,o.classList.add("open"),setTimeout(()=>{o.classList.remove("open")},700)}else GAME_.combo&&(GAME_.combo=0);a="x"===G?f:d.width,A="z"===G?f:d.depth,d.width=a,d.depth=A,d.threejs.scale[G]=b,d.threejs.position[G]-=p/2,d.cannonjs.position[G]-=p/2;let y=new CANNON.Box(new CANNON.Vec3(a/2,GAME_.boxSize.y/2,A/2));if(d.cannonjs.shapes=[],d.cannonjs.addShape(y),u>=.01){let k=Math.sign(p)*(f/2+u/2),v={x:"x"===G?d.threejs.position.x+k:d.threejs.position.x,z:"z"===G?d.threejs.position.z+k:d.threejs.position.z,width:"x"===G?u:a,depth:"z"===G?u:A};l(v.x,v.z,v.width,v.depth)}let w="x"===G?d.threejs.position.x:-(GAME_.boxSize.range-1),_;M(w,"z"===G?d.threejs.position.z:-(GAME_.boxSize.range-1),a,A,"x"===G?"z":"x"),GAME_.score++,c(GAME_.score)}else{$("noob","First time playing"),GAME_.end=!0,GAME_.world.remove(d.cannonjs);let S=new CANNON.Box(new CANNON.Vec3(d.width/2,GAME_.boxSize.y/2,d.depth/2)),z=5,L=new CANNON.Body({mass:z,shape:S});L.position.set(d.threejs.position.x,d.threejs.position.y,d.threejs.position.z),GAME_.world.addBody(L),d.cannonjs=L,e.classList.toggle("disable"),t.classList.toggle("active"),document.body.classList.add("game-end"),GAME_.status=!1,GAME_.soundTrack.game.current[0].pause(),GAME_.soundTrack.next(GAME_.soundTrack.game),GAME_.score>GAME_.bestResult&&(//!TODO This is a rick roll music, don't enable it
playConfetti(GAME_.confetti.range[0],GAME_.confetti.range[1]),GAME_.botMode||(GAME_.bestResult=GAME_.score,window.localStorage.setItem(MEMORY_.localStorage.bestResult,GAME_.score)),r.classList.add("new"),GAME_.newRecord=!0,GAME_.screenshot.service&&(GAME_.screenshot.callback=e=>{s.replaceChild(e,s.querySelector("img")),s.classList.add("display")},GAME_.screenshot.enable=!0)),//!TODO ADD TWO TYPES OF BG AFTER END
GAME_.soundTrack.other.end.currentTime=0,GAME_.soundTrack.other.end.play(),GAME_.soundTrack.menu.current.play(),GAME_.zoomOut.service&&(GAME_.zoomOut.enable=!0);let T=localStorage.getItem(MEMORY_.localStorage.installNo)??!1;enableDownload&&("false"==T||!T)&&(document.querySelector("#pwa-install").classList.add("display"),GAME_.gamesPlayed>0&&document.querySelector("#pwa-dismiss-btn").classList.add("display")),GAME_.gamesPlayed++}}else GAME_.active?g():(GAME_.fpsCtrl.fps=GAME_.fpsCtrl.forceLag?GAME_.fpsCtrl.fps/2:GAME_.fpsCtrl.fps,GAME_.fpsCtrl.fpsInterval=1e3/GAME_.fpsCtrl.fps,GAME_.fpsCtrl.then=m(),x(),GAME_.active=!0,r.querySelector(".score").innerHTML="SCORE"),GAME_.soundTrack.other.start.currentTime=0,GAME_.soundTrack.other.start.play(),GAME_.soundTrack.menu.current.currentTime=0,GAME_.soundTrack.menu.current.pause(),GAME_.soundTrack.game.current[0].play(),c(GAME_.score),M(0,0,GAME_.boxSize.x,GAME_.boxSize.z,"z"),e.classList.toggle("disable"),t.classList.toggle("active"),document.body.classList.remove("game-end"),GAME_.newRecord&&(GAME_.newRecord=!1,r.classList.remove("new")),GAME_.status=!0,GAME_.end=!1;i(hslDark=GAME_.end)};let k="ontouchstart"in window||navigator.msMaxTouchPoints?"touchstart":"mousedown";a.addEventListener(k,fncStart);let v=!0;window.addEventListener("keydown",function(e){(32===e.keyCode||40===e.keyCode||" "===e.key)&&(e.preventDefault(),v&&(v=!1,fncStart()))}),window.addEventListener("keyup",function(e){(32===e.keyCode||40===e.keyCode||" "===e.key)&&(v=!0)}),window.addEventListener("resize",e=>u()),window.addEventListener("orientationchange",e=>{u()}),document.querySelector("#unlock-achie").addEventListener("click",()=>document.body.classList.add("lobby")),document.querySelector("#lock-achie").addEventListener("click",()=>document.body.classList.remove("lobby")),s.addEventListener(k,async()=>{await Blob2Share(GAME_.screenshot.blob,"ios"==GAME_.platform)||h("Unable to share. Take screenshot \uD83D\uDCF8")}),document.addEventListener("visibilitychange",e=>{GAME_.end&&(document.hidden?GAME_.soundTrack.menu.current.pause():GAME_.soundTrack.menu.current.play())},!1),h("This is an <span style='background: rgb(255, 100, 0);'><b>&nbsp;experimental version&nbsp;</b></span>, don't consider this a final version")});