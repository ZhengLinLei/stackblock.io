let GAME_={status:!1,fpsCtrl:{fps:60,fpsInterval:0,now:0,then:0,delta:0},end:!1,active:!1,score:0,combo:0,gamesPlayed:0,bestResult:window.localStorage.getItem("bestResult")?window.localStorage.getItem("bestResult"):0,newRecord:!1,designPalette:0,screenshot:{service:!0,enable:!1,frames:0,callback:null,blob:null},botMode:!1,zoomOut:{service:!0,enable:!1,frames:0,finished:!1}};const colorDesign=[[30,70,50],[120,80,60],[224,68,62],[251,50,60],[339,62,48],[231,50,47],[165,30,68]],boxSize={x:3,y:1,z:3,range:10},c_width=10,cameraPos={width:c_width,height:c_width*(window.innerHeight/window.innerWidth),near:1,far:100,size:700<window.innerWidth?1:2};let world,scene,camera,renderer,fncStart,stackBoxArr=[],outBoxArr=[];function playConfetti(e,t){party.confetti(party.Rect.fromScreen(),{count:party.variation.range(e||60,t||80)})}function playBot(i,e,c=!0){GAME_.botMode=!0;setInterval(()=>{try{var e=stackBoxArr[stackBoxArr.length-1],t=stackBoxArr[stackBoxArr.length-2],o=e.direction,s=e.threejs.position[o]-t.threejs.position[o],r=Math.abs(s),n="x"===o?e.width:e.depth,a=(n-r)/n;(i||.95)<=a&&(fncStart(),c)&&console.log(a)}catch(e){fncStart()}},e||20)}window.addEventListener("load",()=>{let c=document.querySelector(".result-area"),l=document.querySelector(".point-result"),d=document.querySelector(".score-tab"),h=document.querySelector(".combo-strike"),m=document.querySelector(".combo-extra-point");var e=document.querySelector("#click-event");let A=document.querySelector("#record-share");function p(){scene.background=new THREE.Color(u(colorDesign[GAME_.designPalette][0]+120+stackBoxArr.length,colorDesign[GAME_.designPalette][1],colorDesign[GAME_.designPalette][2]))}function E(e){l.innerHTML=e}function w(e,t,o,s,r){e=M(e,boxSize.y*stackBoxArr.length,t,o,s,!1);e.direction=r,e.positive=!0,stackBoxArr.push(e)}function M(e,t,o,s,r,n=!1){var a=n?4*(stackBoxArr.length-1):4*stackBoxArr.length,a=new THREE.Color(u(colorDesign[GAME_.designPalette][0]+a,colorDesign[GAME_.designPalette][1],colorDesign[GAME_.designPalette][2])),i=new THREE.BoxGeometry(s,boxSize.y,r),a=new THREE.MeshLambertMaterial({color:a}),c=new THREE.Mesh(i,a),l=(c.position.set(e,t,o),new CANNON.Box(new CANNON.Vec3(s/2,boxSize.y/2,r/2))),n=new CANNON.Body({mass:n?5:0,shape:l});return n.position.set(e,t,o),world.addBody(n),scene.add(c),{threejs:c,geometry:i,material:a,cannonjs:n,x:e,y:t,z:o,width:s,depth:r}}function u(t,e,o){o=101<o?100:o,o/=100;const s=e*Math.min(o,1-o)/100;e=e=>{e=(e+t/30)%12,e=o-s*Math.max(Math.min(e-3,9-e,1),-1);return Math.round(255*e).toString(16).padStart(2,"0")};return"#"+e(0)+e(8)+e(4)}function x(){camera.right=cameraPos.width/cameraPos.size,camera.left=cameraPos.width/-cameraPos.size,camera.top=cameraPos.height/cameraPos.size,camera.bottom=cameraPos.height/-cameraPos.size,camera.updateProjectionMatrix()}function g(){return"now"in window?now():("now"in performance&&"performance"in window?performance:Date).now()}(world=new CANNON.World).gravity.set(0,-9.8,0),world.broadphase=new CANNON.NaiveBroadphase,world.solver.interations=40,E(GAME_.bestResult),scene=new THREE.Scene,p(),w(0,0,boxSize.x,boxSize.z,"x");var t=new THREE.AmbientLight(16777215,.6),t=(scene.add(t),new THREE.DirectionalLight(16777215,.6));function o(){var e,t;GAME_.end?(stackBoxArr[stackBoxArr.length-1].threejs.position.copy(stackBoxArr[stackBoxArr.length-1].cannonjs.position),stackBoxArr[stackBoxArr.length-1].threejs.quaternion.copy(stackBoxArr[stackBoxArr.length-1].cannonjs.quaternion),GAME_.zoomOut.enable&&(cameraPos.size-=.02,x(),GAME_.zoomOut.frames++,20<=GAME_.zoomOut.frames)&&(GAME_.zoomOut.enable=!1,GAME_.zoomOut.frames=0,GAME_.zoomOut.finished=!0)):(t=(e=stackBoxArr[stackBoxArr.length-1]).positive?.15:-.15,e.threejs.position[e.direction]>=boxSize.range-5&&(e.positive=!1),e.threejs.position[e.direction]<=-(boxSize.range-5)&&(e.positive=!0),e.threejs.position[e.direction]+=t,e.cannonjs.position[e.direction]+=t,camera.position.y<boxSize.y*(stackBoxArr.length-2)+4&&(camera.position.y+=t)),world.step(1/60),outBoxArr.forEach(e=>{e.threejs.position.copy(e.cannonjs.position),e.threejs.quaternion.copy(e.cannonjs.quaternion)}),renderer.render(scene,camera),GAME_.screenshot.enable&&(5<=GAME_.screenshot.frames?GAME_.zoomOut.finished&&(DrawCanvasCopy(renderer.domElement,e=>{e.fillStyle="rgba(0, 0, 0, 0.2)",e.fillRect(0,0,e.canvas.width,e.canvas.height),e.fillStyle="#ffffff",e.font="32px monospace";var t="NEW RECORD",o=e.measureText(t).width;e.fillText(t,e.canvas.width/2-o/2,e.canvas.height/2-100),e.font="bold 64px monospace",t=GAME_.score,o=e.measureText(t).width,e.fillText(t,e.canvas.width/2-o/2,e.canvas.height/2+50),GAME_.botMode&&(e.save(),e.translate(e.canvas.width/2,e.canvas.height/2+50),e.rotate(-Math.PI/8),e.fillStyle="rgba(255, 0, 0, 0.6)",e.font="bold 64px monospace",o=e.measureText(t="FAKE").width,e.fillText(t,-o/2,0),e.strokeStyle="rgba(255, 0, 0, 0.5)",e.lineWidth=5,e.strokeRect(-(o/2+10),-51.152,o+20,56.152),e.restore())},e=>{var t=document.createElement("img");const o=URL.createObjectURL(e);t.onload=()=>{URL.revokeObjectURL(o)},t.src=o,GAME_.screenshot.blob=e,GAME_.screenshot.callback(t)}),GAME_.screenshot.enable=!1,GAME_.screenshot.frames=0):GAME_.screenshot.frames++)}function f(){requestAnimationFrame(f),GAME_.fpsCtrl.now=g(),GAME_.fpsCtrl.elapsed=GAME_.fpsCtrl.now-GAME_.fpsCtrl.then,GAME_.fpsCtrl.elapsed>GAME_.fpsCtrl.fpsInterval&&(GAME_.fpsCtrl.then=GAME_.fpsCtrl.now-GAME_.fpsCtrl.elapsed%GAME_.fpsCtrl.fpsInterval,o())}t.position.set(10,20,0),scene.add(t),(camera=new THREE.OrthographicCamera(cameraPos.width/-cameraPos.size,cameraPos.width/cameraPos.size,cameraPos.height/cameraPos.size,cameraPos.height/-cameraPos.size,cameraPos.near,cameraPos.far)).position.set(4,4,4),camera.lookAt(0,0,0),(renderer=new THREE.WebGLRenderer({antialias:!0})).setSize(window.innerWidth,window.innerHeight),renderer.render(scene,camera),renderer.domElement.id="Stackblock",document.body.appendChild(renderer.domElement),fncStart=()=>{var e,t,o,s,r,n,a,i;GAME_.status?(o=stackBoxArr[stackBoxArr.length-1],r=stackBoxArr[stackBoxArr.length-2],s=o.direction,r=o.threejs.position[s]-r.threejs.position[s],i=Math.abs(r),0<(n=(a="x"===s?o.width:o.depth)-i)?(a=n/a,i<.2?([9,19,29,39,49].includes(GAME_.combo)&&(m.classList.add("active"),setTimeout(()=>{m.classList.remove("active")},1100),GAME_.score+=10),GAME_.combo+=1,h.innerHTML="x"+GAME_.combo,h.classList.add("open"),setTimeout(()=>{h.classList.remove("open")},700)):GAME_.combo&&(GAME_.combo=0),e="x"===s?n:o.width,t="z"===s?n:o.depth,o.width=e,o.depth=t,o.threejs.scale[s]=a,o.threejs.position[s]-=r/2,o.cannonjs.position[s]-=r/2,a=new CANNON.Box(new CANNON.Vec3(e/2,boxSize.y/2,t/2)),o.cannonjs.shapes=[],o.cannonjs.addShape(a),.01<=i&&(a=Math.sign(r)*(n/2+i/2),r={x:"x"===s?o.threejs.position.x+a:o.threejs.position.x,z:"z"===s?o.threejs.position.z+a:o.threejs.position.z,width:"x"===s?i:e,depth:"z"===s?i:t},n=r.z,a=r.width,i=r.depth,r=M(r=r.x,boxSize.y*(stackBoxArr.length-1),n,a,i,!0),outBoxArr.push(r)),w("x"===s?o.threejs.position.x:-(boxSize.range-1),"z"===s?o.threejs.position.z:-(boxSize.range-1),e,t,"x"===s?"z":"x"),GAME_.score++,p(),E(GAME_.score)):(GAME_.end=!0,world.remove(o.cannonjs),n=new CANNON.Box(new CANNON.Vec3(o.width/2,boxSize.y/2,o.depth/2)),(a=new CANNON.Body({mass:5,shape:n})).position.set(o.threejs.position.x,o.threejs.position.y,o.threejs.position.z),world.addBody(a),o.cannonjs=a,c.classList.toggle("disable"),l.classList.toggle("active"),GAME_.status=!1,GAME_.score>GAME_.bestResult&&(playConfetti(),GAME_.botMode||(GAME_.bestResult=GAME_.score,window.localStorage.setItem("bestResult",GAME_.score)),d.classList.add("new"),GAME_.newRecord=!0,GAME_.screenshot.service)&&(GAME_.screenshot.callback=e=>{A.replaceChild(e,A.querySelector("img")),A.classList.add("display")},GAME_.screenshot.enable=!0),GAME_.zoomOut.service&&(GAME_.zoomOut.enable=!0),i=localStorage.getItem("installDismissed")??!1,!enableDownload||"false"!=i&&i||(document.querySelector("#pwa-install").classList.add("display"),0<GAME_.gamesPlayed&&document.querySelector("#pwa-dismiss-btn").classList.add("display")),GAME_.gamesPlayed++)):(GAME_.active?(GAME_.designPalette=Math.floor(Math.random()*colorDesign.length),cameraPos.size=700<window.innerWidth?1:2,x(),camera.position.set(4,4,4),camera.lookAt(0,0,0),GAME_.zoomOut.finished=!1,stackBoxArr.forEach(e=>{scene.remove(e.threejs),e.geometry.dispose(),e.material.dispose(),world.removeBody(e.cannonjs)}),outBoxArr.forEach(e=>{scene.remove(e.threejs),e.geometry.dispose(),e.material.dispose(),world.removeBody(e.cannonjs)}),stackBoxArr=[],outBoxArr=[],GAME_.score=0,GAME_.combo=0,p(),w(0,0,boxSize.x,boxSize.z,"x"),document.querySelector("#pwa-install").classList.remove("display"),A.classList.remove("display")):(GAME_.fpsCtrl.fpsInterval=1e3/GAME_.fpsCtrl.fps,GAME_.fpsCtrl.then=g(),f(),GAME_.active=!0,d.querySelector(".score").innerHTML="SCORE"),E(GAME_.score),w(0,0,boxSize.x,boxSize.z,"z"),c.classList.toggle("disable"),l.classList.toggle("active"),GAME_.newRecord&&(GAME_.newRecord=!1,d.classList.remove("new")),GAME_.status=!0,GAME_.end=!1)};t="ontouchstart"in window||navigator.msMaxTouchPoints?"touchstart":"mousedown";e.addEventListener(t,fncStart);let s=!0;window.addEventListener("keydown",function(e){32!==e.keyCode&&40!==e.keyCode&&" "!==e.key||(e.preventDefault(),s&&(s=!1,fncStart()))}),window.addEventListener("keyup",function(e){32!==e.keyCode&&40!==e.keyCode&&" "!==e.key||(s=!0)}),A.addEventListener(t,async()=>{await Blob2Share(GAME_.screenshot.blob)||Blob2Download(GAME_.screenshot.blob)})});